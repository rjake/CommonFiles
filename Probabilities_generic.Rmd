---
title: "When does it occur?"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F#, fig.width = 4, fig.height = 3
                      )
```

###Learn about patterns in your data
This script is used to look at patterns within your data. The script goes through each available value within each column and builds charts to determine the proportion of times that each value occur with the dependent variable. Continuous variables (numbers) are split into quartiles (though whether it is groups of 4 or another number is easily changed) and are then factorized and evaluated as categorical data. Values that represent less than 1% of the data are omitted as they are often rare events and clutter up the charts.

Using the space below, enter the file name and variable you wish to test. Enter the ```fileName``` with its extension and put it in quotes (ex. "this is my data.csv"). Then type the logical test you want to observe (ex. "Sepal.Length >= 6.5") This should be the column name of your data. Note that R column names do not have spaces or other punctuation. These characters will be replaced by a period when R reads in the file. Thus, use a period here or edit the column names before bringing in the file. 

```{r echo = T}
#set work space
  setwd("J:/Portfolio/Comcast/Predictive")

#load data (must be CSV format)
  fileName <- "iris.csv"


#logical statement to test, left side is column name, right side is test
  test.dv <- "Sepal.Length > 6.5"
```


The code will run from here...

```{r}
library(tidyverse)
library(corrplot)
library(knitr)

options(scipen = 999)

cut_quantile <- function(x){
  cut(x, 
      breaks = unique(quantile(x, na.rm = T)),
      include.lowest = T, 
      dig.lab = 10, 
      right = F,
      ordered_result = T)
} 

data.raw <- read.csv(file = fileName, stringsAsFactors = F, 
                     na.strings = c("NA", ""))

data.raw <- 
  data.raw %>% 
  mutate_(TestDV = test.dv) %>%
  filter(complete.cases(.))
```

```{r}
classData <-  
  data.frame(Name=colnames(data.raw)) %>% 
  mutate(Class=sapply(data.raw, class))

dataColChar <- which(classData$Class=="character")
dataColLog  <- which(classData$Class=="logical")  
dataColFact <- which(classData$Class=="factor")    
dataColInt  <- which(classData$Class=="integer")
dataColNum  <- which(classData$Class=="numeric")  

#Character data
cData <- select(data.raw, dataColChar, dataColFact, dataColLog)%>%
  gather(key="Var", value = "Response", -TestDV, na.rm = T) %>%
  filter(Var != gsub(" .*", "",test.dv)) %>%
  mutate(Var=as.character(Var),
         Original = Response) %>% 
  arrange(Response) %>% 
  group_by(Var) %>% 
  mutate(Order = as.integer(factor(Response))) %>% 
  ungroup()

#Numeric data (has decimal place)
nData <- select(data.raw, c(dataColNum, dataColInt))%>%
  cbind(select(data.raw, TestDV)) %>% 
  gather(key="Var", value = "Original", -TestDV, na.rm = T) %>%
  filter(Var != gsub(" .*", "",test.dv)) %>% 
  group_by(Var) %>% 
  mutate(Response = cut_quantile(Original),
         Order = as.integer(factor(Response))) %>%
  ungroup() %>% 
  mutate(Response = gsub(",", " to ", Response))


data.both <- 
  rbind(cData, nData) 
  #group_by(Var, Response, Order) %>% 
  #summarise(N = n()) %>% 
  #ungroup()

```

###Create plots
```{r}
theme_forcharts <- 
    theme(axis.text = element_blank(),
          panel.background = element_blank(),
          #panel.border = element_rect(colour = "black", fill = NA), 
          axis.title = element_blank(),
          plot.title = element_text(hjust = 0),
          axis.ticks = element_blank(),
          panel.margin=unit(.05, "lines"),
          panel.border = element_rect(color = "grey50", fill = NA, size = 1), 
          strip.background = element_rect(color = "grey50", size = 1),
          aspect.ratio = 1)

chart_colors <- c("#aba5a5", "#ea7e26")
  
ggplot(cData, aes(x=Original, fill = TestDV)) +
  facet_wrap(~Var, scales="free", ncol = 4) +
  theme_forcharts +
  geom_bar() +
  scale_fill_manual(values = chart_colors) +
  ggtitle("Data Type: Text")

ggplot(nData, aes(x=Original, fill = TestDV)) +
  facet_wrap(~Var, scales="free", ncol = 4) +
  theme_forcharts +
  geom_bar()+
  scale_fill_manual(values = chart_colors) +
  ggtitle("Data Type: Numeric & Integers")

```

###As factors, numeric values are cut into quartiles and become factors
```{r eval = T}
nVars <- distinct(data.both, Var)

for(i in 1:nrow(nVars)){
#i = 2

  a <- data.both %>% 
    group_by(Var, Response, Order, TestDV) %>% 
    summarise(N = n()) %>%
    group_by(Var, Response) %>% 
    mutate(Total = sum(N)) %>%
    group_by(Var) %>% 
    mutate(Max = max(Total)) %>%
    ungroup() %>% 
    mutate(PctResp = N/Total,
           PctAll = Total/Max)

  data.prep <- 
    filter(a, Var == nVars$Var[i]) 
  
  data.prep.factor <- 
    distinct(data.prep, Order, Response) %>% 
    arrange(Order)
  
  data.prep$Response2 <-
    factor(data.prep$Order, labels = data.prep.factor$Response)
                                
#  levels(data.prep$Response2)
  
    p <- 
    ggplot(filter(data.prep, 
                  Total > (nrow(data.raw)/nrow(nVars)*.05)), 
         aes(x= Response2, 
             y = PctResp, fill = TestDV, width = PctAll))+#, y=Count))+
    geom_bar(stat = "identity", position = "fill", color = "white") +
    #facet_grid(Var~., scales="free_x", space = "free") +
    #coord_equal(1) +
    coord_flip() +
    scale_fill_manual(values = chart_colors) +
    ggtitle(paste0("Factor: ", nVars$Var[i], "       (", test.dv, ")")) +
    theme(panel.background = element_blank(),
          axis.title = element_blank(),
          plot.title = element_text(hjust = 0),#, size = 20),
          axis.ticks = element_blank(),
          panel.margin=unit(.05, "lines"),
          panel.border = element_rect(color = "grey50", fill = NA), 
          strip.background = element_rect(color = "grey50", size = 1)
          )

print(p)
}
```

```{r eval = F}
#not using
#data.factor <- 
#  filter(data.both, Var == nVars$Var[i]) %>% 
#  group_by(Response) %>% 
#  summarise(Original = min(Original)) %>% 
#  ungroup() %>% 
#  arrange(Original)

#data.plot <- 
#  filter(data.both, Var == nVars$Var[i]) %>% 
#  mutate(Response = factor(Response, 
#                           levels = data.factor$Response,
#                           labels = gsub(",", " to ", )))
```

##Correlation Matrix (integer & numeric values only)
```{r}
#Correlations
select(data.raw, c(dataColNum, dataColInt))%>%
  cor(use = "complete.obs")%>%
  corrplot.mixed(tl.cex=1, order = "hclust", lower = "circle", upper = "number")
```

##Variable frequency breakdown
```{r}
dataProp <- 
  data.both %>% 
  group_by(TestDV, Var, Response) %>% 
  summarise(N = n()) %>% 
  group_by(Var, Response) %>% 
  mutate(Total = sum(N),
         Pct = round(N/Total, 2)) %>% 
  ungroup() %>% 
  arrange(-Pct)

filter(dataProp, TestDV == 1)%>% 
  #arrange(Var, TestDV, -Pct) %>% 
  kable(caption = paste0("Frequency of ", test.dv, " occurance"))
        
filter(dataProp, TestDV == 0,
       Pct == 1)%>% 
  #arrange(Var, TestDV, -Pct) %>% 
  kable(caption = paste0("Where ", test.dv, " never occurs"))
```





```{r eval = F}
a <- data.both %>% 
      group_by(Var, Response, TestDV) %>% 
#      mutate(Order = row_number())
      summarise(N = n())
p <-     
  ggplot(a, 
       aes(x = 0, 
           y = reorder(Response, N),
           xend = N, 
           yend = reorder(Response, N), 
           color = TestDV)) +
  geom_segment(size=2) + 
  facet_grid(Var~., scales = "free", space = "free")

  print(p)
#} 
```


```{r eval = F}
library(caret)
#forReg <-
  select(data.raw, c(dataColNum, dataColInt)) %>% 
  mutate_each(funs(cut_quantile)) %>% 
  cbind(select(data.raw, c(dataColChar, dataColFact, dataColLog)))

reg <- glm(TestDV ~ ., family=binomial, data = forReg)
summary(reg)

b <- 
  coef(summary(reg)) %>% 
  as.data.frame() %>% 
  mutate(Var = row.names(.)) %>% 
  mutate_each(funs(round(., 4)), 1:4) %>%
  mutate(Signif = `Pr(>|z|)` < 0.05)

#http://stats.stackexchange.com/questions/5354/logistic-regression-model-does-not-converge
varImp(reg, scale = F) %>% 
  as.data.frame() %>% 
  mutate(Name = row.names(.)) %>% 
  arrange(-Overall) %>% 
  head()
```

